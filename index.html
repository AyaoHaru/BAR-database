<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock and Coins Manager</title>
</head>
<body>
  <h2>Enter your ID</h2>
  <input type="text" id="userID" placeholder="Your ID" />
  <button onclick="fetchUser()">Get Info</button>
  
  <div id="userInfo" style="display:none;">
    <p>Stock: <span id="stock"></span></p>
    <p>Coins: <span id="coins"></span></p>
    
    <input type="number" id="stockChange" placeholder="Stocks to buy (+) or sell (-)" />
    <button onclick="submitTransaction()">Submit</button>
  </div>
  
  <script>
    const NOTION_API_TOKEN = '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';
    const DATABASE_ID = '23e78abfd47880d39f15c9bcb6a36823';
    
    async function fetchUser() {
      const userId = document.getElementById('userID').value;
      if(!userId) return alert('Please enter your ID');
      
      // Query Notion database for user with ID = userId
      const queryUrl = `https://api.notion.com/v1/databases/${DATABASE_ID}/query`;
      const response = await fetch(queryUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${NOTION_API_TOKEN}`,
          'Notion-Version': '2022-06-28',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          filter: {
            property: 'ID',
            rich_text: {
              equals: userId
            }
          }
        })
      });
      const data = await response.json();
      if(data.results.length === 0) {
        alert('User not found');
        return;
      }
      window.currentUser = data.results[0]; // save the page for updates
      
      const stock = currentUser.properties.Stock.number;
      const coins = currentUser.properties.Coins.number;
      document.getElementById('stock').textContent = stock;
      document.getElementById('coins').textContent = coins;
      document.getElementById('userInfo').style.display = 'block';
    }
    
    async function submitTransaction() {
      if(!window.currentUser) return alert('No user loaded');
      const stockChange = parseInt(document.getElementById('stockChange').value);
      if(isNaN(stockChange)) return alert('Enter a valid number');
      
      let stock = window.currentUser.properties.Stock.number || 0;
      let coins = window.currentUser.properties.Coins.number || 0;
      
      // Assuming each stock costs 1 coin for simplicity
      const coinChange = -stockChange; 
      
      const newStock = stock + stockChange;
      const newCoins = coins + coinChange;
      
      if(newStock < 0 || newCoins < 0) {
        return alert('Not enough stocks or coins');
      }
      
      // Update Notion page with new values
      const updateUrl = `https://api.notion.com/v1/pages/${window.currentUser.id}`;
      const response = await fetch(updateUrl, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${NOTION_API_TOKEN}`,
          'Notion-Version': '2022-06-28',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          properties: {
            Stock: {
              number: newStock
            },
            Coins: {
              number: newCoins
            }
          }
        })
      });
      
      if(response.ok) {
        alert('Transaction successful!');
        document.getElementById('stock').textContent = newStock;
        document.getElementById('coins').textContent = newCoins;
      } else {
        alert('Error updating data');
      }
    }
  </script>
</body>
</html>
